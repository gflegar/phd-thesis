%%%% Required: template setup
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% basic document setup
\documentclass[a4paper,11pt,twoside]{book}
\usepackage[left=2cm,right=2cm,top=2cm,bottom=2cm,head=26pt]{geometry}
\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{mathptmx}  % fonts
% suppress warning with the bullet character
\DeclareTextCommandDefault{\textbullet}{\ensuremath{\bullet}}
\usepackage[scaled]{helvet}  % fix size of helvetica fonts
\usepackage[square,sort,comma,numbers]{natbib}

% Paper inclusion
\usepackage[sectionbib]{bibunits}
\usepackage{bibentry}
\usepackage{color}
\usepackage{import}
\usepackage{suffix}
\usepackage{verbatimcopy}

% NOTE: There is an issue with interoperability between import and bibunits (and
% probably between import and citations in general), where, due to import's
% mangling of input file paths (but not of output file paths), temporary files
% get written to the top-level directory, but are then expected inside the child
% directory.
%
% To fix this issue, auxiliary files generated by bibunits are also copied to
% the appropriate subfolder using the verbatimcopy package.

\makeatletter

% Includes a chapter from a subfolder
\newcommand\includechapter[3]{
    \chapter{#2}
    \chaptermark{#3}
    \label{ch:#1}
    \begin{bibunit}[abbrvnat]
    \import*{#1/}{body}
    \putbib[#1/references]
    \end{bibunit}
    \OldVerbatimCopy{\@bibunitname.aux}{#1/\@bibunitname.aux}
}

% Includes an unnamed chapter from a subfolder, and without a reference section
\WithSuffix\newcommand\includechapter*[2]{
    \chapter*{#2}
    \label{ch:#1}
    \import*{#1/}{body}
}

% includes a paper from a subfolder
\newcommand\includepaper[4]{
    \chapter{#2}
    \chaptermark{#3}
    \label{ch:#1}
    \begin{quote}
    \textbf{Published as:}
    \bibentry{#4}
    \end{quote}
    \begin{bibunit}[abbrvnat]
    \textit{\import*{#1/}{abstract}}
    \import*{#1/}{body}
    \putbib[#1/references]
    \end{bibunit}
    % make sure that the bibliography files are written into the subfolder
    \OldVerbatimCopy{\@bibunitname.aux}{#1/\@bibunitname.aux}
}

\makeatother

% frontmatter dependencies
\usepackage{titling}
\usepackage{graphicx}
\newcommand{\advisor}[1]{\def \theadvisor {#1}}
\newcommand{\coadvisor}[1]{\def \thecoadvisor {#1}}
\newcommand{\subject}[1]{\def \thesubject {#1}}
\newcommand{\keywords}[1]{\def \thekeywords {#1}}

% TOC setup
\setcounter{secnumdepth}{4}
\setcounter{tocdepth}{4} 

% Header and footer setup
\usepackage{fancyhdr}
\fancyhf{}
\renewcommand\bibsection{\section*{\bibname}}
\renewcommand\chaptermark[1]{\markboth{Chapter \thechapter. #1}{}}
\renewcommand\sectionmark[1]{\markright{\thesection. #1}{}}
\renewcommand\headrulewidth{0.2pt}
\renewcommand\footrulewidth{0.1pt}
\fancyfoot[LE,RO]{\thepage} 
\fancyhead[RO]{{\sffamily \rightmark}}
\fancyhead[LE]{{\sffamily \leftmark}}

% \show\thebibliography

% Chapter setup
\usepackage[Bjornstrup]{fncychap}
% solve a bug in Bjornstrup, see: https://tex.stackexchange.com/a/89786/160826
\makeatletter
  \renewcommand{\DOCH}{%
    \settowidth{\py}{\CNoV\thechapter}%
    \addtolength{\py}{-10pt}%
    \fboxsep=0pt%
    \colorbox[gray]{.85}{\rule{0pt}{40pt}\parbox[b]{\textwidth}{\hfill}}%
    \kern-\py\raise20pt%
    \hbox{\color[gray]{.5}\CNoV\thechapter}%
    \kern-\myhi%
    \\%
  }
\makeatother
% The original font used for chapter numbers by Bjornstrup is not available,
% use the ptm font from mathptmx
\ChNumVar{\fontsize{76}{80}\usefont{T1}{ptm}{m}{it}\selectfont}

% If you need to debug the layout, uncomment the following two lines:
% \usepackage{showframe}
% \usepackage{layout}
\providecommand{\layout}{}

%%%% Optional: additional packages and configurations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% AMS mathematics
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsthm}
\theoremstyle{definition}
\newtheorem{definition}{Definition}[chapter]
\theoremstyle{plain}
\newtheorem{proposition}[definition]{Proposition}
\newtheorem{corollary}[definition]{Corollary}
\newtheorem{lema}[definition]{Lema}
\newtheorem{theorem}[definition]{Theorem}
\theoremstyle{remark}
\newtheorem{remark}[definition]{Remark}

% remove warnings for multiple PDFs included on a single page
\pdfsuppresswarningpagegroup=1

% Listings
\usepackage{listings}
\lstloadlanguages{C,C++,Matlab}
\definecolor{slbase02}{RGB}{7,54,66}
\definecolor{slbase0}{RGB}{131,148,150}
\definecolor{slbase1}{RGB}{147,161,161}
\definecolor{slbase3}{RGB}{253,246,227}
\definecolor{slcyan}{RGB}{42,161,152}
\definecolor{slgreen}{RGB}{133,153,0}
\lstdefinestyle{common}{
    basicstyle=\footnotesize,
    identifierstyle=\textcolor{slbase02},
    commentstyle=\textcolor{slbase0},
    stringstyle=\textcolor{slcyan},
    keywordstyle=\bfseries\textcolor{slgreen},
    numbers=left,
    numberstyle=\textcolor{slbase0},
    xleftmargin=2em,
    xrightmargin=2em,
    breaklines=true,
    breakatwhitespace=true,
    frame=tb,
    backgroundcolor=\color{slbase3}
}
\lstset{style=common}

% Other utilities
\usepackage{adjustbox}  % adjustbox evnironment
\usepackage{booktabs}   % improved tables
\usepackage{caption}    % better figure captions
\usepackage{float}      % improved float behavior
\usepackage{pdflscape}  % landscape pages
\usepackage{rotating}   % for vertical text
\usepackage{multirow}   % table cells spanning multiple rows
\usepackage{subcaption} % subfigure environment
\usepackage{url}        % \url command
\usepackage{xspace}     % \xspace command - prevents eating spaces

\usepackage[
    breaklinks,
    bookmarksnumbered]
    {hyperref}   % generate hyperlinks

\input{cover}
\input{macros}

\begin{document}

\bibliographystyle{abbrvnat}
\nobibliography{included}

\layout{}
% Remove comments from the text
%\nocomments

\frontmatter
\pagestyle{plain}

% Change the information about your thesis here:
% \title{Accelerating the Solution of Sparse Linear Systems on Graphics
%        Processing Units}
\title{Sparse Linear System Solvers on GPUs: \\
    Parallel Preconditioning, Workload Balancing, and Communication Reduction}
\author{Goran Flegar}
\advisor{Enrique S. Quintana-Ort\'{i}}
\coadvisor{Hartwig Anzt}
\subject{Computer Science}
\keywords{High Performance Computing, Graphics Processing Units, %
Linear Systems, Krylov Methods, Sparse Matrix-Vector Product, Preconditioning, %
Mixed Precision, Adaptive Precision}
\date{March 2019}
\maketitle
%%%

\includechapter*{abstract}{Abstract}

\cleardoublepage
\tableofcontents

\includechapter*{acknowledgements}{Acknowledgements}

\cleardoublepage
\begin{center}
    \vspace*{\fill}
    \textit{
    To my friend \ldots \\ \hspace{2cm}
    right till the end.
    }
    \vspace*{\fill}
\end{center}

\mainmatter
\pagestyle{fancy}

\part{Prologue}
\label{pt:prologue}

\includechapter{introduction}{Introduction}{Introduction}

\part{Sparse Matrix Formats and Matrix-Vector Product}
\label{pt:matrix-vector}

\includepaper{2017-csr-spmv}
    {Balanced Sparse Matrix-Vector Product for the CSR Matrix Format}
    {Balanced CSR \spmv}
    {csr-spmv}

\includepaper{2017-coo-spmv}
    {Balanced Sparse Matrix-Vector Product for the COO Matrix Format}
    {Balanced COO \spmv}
    {coo-spmv}

\includepaper{2017-batched-spmv}
    {Matrix-Vector Product Algorithms for Individual Streaming Multiprocessors}
    {\spmv for a Single SM}
    {batched-spmv}

\part{Preconditioning}
\label{pt:preconditioning}

\includepaper{2017-gje-block-jacobi}
    {Block-Jacobi Preconditioning Using Explicit Inversion}
    {Inversion-Based Block-Jacobi Preconditioning}
    {gje-block-jacobi}

\includepaper{2017-gh-block-jacobi}
    {Block-Jacobi Preconditioning Based on Gauss-Huard Decomposition}
    {GH-Based Block-Jacobi Preconditioning}
    {gh-block-jacobi}

\includepaper{2017-lu-block-jacobi}
    {Block-Jacobi Preconditioning Based on LU Factorization}
    {LU-Based Block-Jacobi Preconditioning}
    {lu-block-jacobi}

\part{Towards Adaptive Precision Methods}
\label{pt:adaptive}

\includepaper{2017-adaptive-block-jacobi}
    {Leveraging Adaptive Precision in Block-Jacobi Preconditioning}
    {Adaptive Precision Block-Jacobi Preconditioning}
    {adaptive-block-jacobi}

\part{Epilogue}
\label{pt:epilogue}

\includechapter{conclusion}{Into the Great Unknown}{Into the Great Unknown}

\appendix

\backmatter
\pagestyle{plain}

\listoffigures
\addcontentsline{toc}{chapter}{List of Figures}
\cleardoublepage

\listoftables
\addcontentsline{toc}{chapter}{List of Tables}
\cleardoublepage

\end{document}
